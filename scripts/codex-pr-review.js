import OpenAI from "openai";
import { execSync } from "node:child_process";
import fs from "node:fs";
import os from "node:os";
import path from "node:path";

function sh(cmd, options = {}) {
  return execSync(cmd, { encoding: "utf8", stdio: "pipe", ...options });
}

// --------------------
// Context from Actions
// --------------------
const apiKey = process.env.OPENAI_API_KEY;
const prNumber = process.env.GITHUB_REF_NAME?.split("/")[0]; // "1/merge" -> "1"
const baseRef = process.env.GITHUB_BASE_REF; // usually "main" on pull_request

if (!apiKey) {
  console.error("Missing OPENAI_API_KEY. Add it in GitHub Actions secrets.");
  process.exit(1);
}

if (!prNumber || !baseRef) {
  console.log("Not running on a pull_request event (missing PR context). Exiting.");
  process.exit(0);
}

// --------------------
// Get diff
// --------------------
try {
  sh(`git fetch origin ${baseRef} --depth=1 || true`);
} catch (e) {
  // Non-fatal; we can still attempt diff.
}

let diff = "";
try {
  diff = sh(`git diff origin/${baseRef}...HEAD || true`);
} catch (e) {
  diff = "";
}

// Keep prompt size reasonable
const diffSnippet = diff.slice(0, 12000);

// --------------------
// Ask OpenAI
// --------------------
const openai = new OpenAI({ apiKey });

const prompt = `
You are a senior software engineer.

Review this pull request diff and provide:
1. Key risks or bugs
2. Suggested improvements
3. Tests to add
4. Security concerns (if any)

Be concise and actionable.

DIFF:
${diffSnippet}
`;

let response;
try {
  response = await openai.responses.create({
    model: "gpt-5.2",
    input: prompt
  });
} catch (err) {
  // If OpenAI fails, post a helpful comment anyway (optional)
  const fallback = `## Codex Assistant Review

OpenAI request failed: ${err?.message || "Unknown error"}

<sub>Automated review generated by OpenAI</sub>
`;
  const tmpPath = path.join(os.tmpdir(), `codex-review-${prNumber}.md`);
  fs.writeFileSync(tmpPath, fallback, "utf8");
  sh(`gh pr comment ${prNumber} --body-file "${tmpPath}"`);
  console.log("Posted fallback comment (OpenAI request failed).");
  process.exit(0);
}

const reviewText = (response?.output_text || "").trim();

// Always non-empty body
const body = reviewText
  ? `## Codex Assistant Review

${reviewText}

<sub>Automated review generated by OpenAI</sub>
`
  : `## Codex Assistant Review

I ran successfully, but the model returned no text. Try re-running the workflow.

<sub>Automated review generated by OpenAI</sub>
`;

// --------------------
// Post PR comment safely via body-file
// --------------------
const tmpPath = path.join(os.tmpdir(), `codex-review-${prNumber}.md`);
fs.writeFileSync(tmpPath, body, "utf8");

sh(`gh pr comment ${prNumber} --body-file "${tmpPath}"`);

console.log("Posted PR comment successfully.");
