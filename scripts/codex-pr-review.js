import OpenAI from "openai";
import { execSync } from "node:child_process";

function sh(cmd, options = {}) {
  return execSync(cmd, { encoding: "utf8", ...options });
}

// Init OpenAI
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

// PR context from GitHub Actions
const prNumber = process.env.GITHUB_REF_NAME?.split("/")[0];
const baseRef = process.env.GITHUB_BASE_REF; // usually "main"

if (!prNumber || !baseRef) {
  console.log("Not running on a pull_request event. Exiting.");
  process.exit(0);
}

// Make sure base branch exists locally
sh(`git fetch origin ${baseRef} --depth=1 || true`);

// Get PR diff
const diff = sh(`git diff origin/${baseRef}...HEAD || true`).slice(0, 12000);

const prompt = `
You are a senior software engineer.

Review this pull request diff and provide:
1. Key risks or bugs
2. Suggested improvements
3. Tests to add
4. Security concerns (if any)

Be concise and actionable.

DIFF:
${diff}
`;

// Call OpenAI
const response = await openai.responses.create({
  model: "gpt-5.2",
  input: prompt
});

// Extract text safely
const reviewText = (response.output_text || "").trim();

// Always ensure a non empty comment body
const body = reviewText
  ? `## Codex Assistant Review\n\n${reviewText}\n\n<sub>Automated review generated by OpenAI</sub>\n`
  : `## Codex Assistant Review\n\nI ran successfully, but the model returned no text. Try re running the workflow.\n`;

// Post PR comment using GitHub CLI
sh(`gh pr comment ${prNumber} --body "${body.replace(/"/g, '\\"')}"`);

console.log("Posted PR comment successfully.");
