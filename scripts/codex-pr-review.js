import OpenAI from "openai";
import { execSync } from "node:child_process";

function sh(cmd) {
  return execSync(cmd, { encoding: "utf8" });
}

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

const prNumber = process.env.GITHUB_REF_NAME?.split("/")[0];
const baseRef = process.env.GITHUB_BASE_REF; // "main" on PRs

if (!prNumber || !baseRef) {
  console.log("Not running on a pull_request event. Exiting.");
  process.exit(0);
}

// Make sure we have the base branch locally
sh(`git fetch origin ${baseRef} --depth=1 || true`);

const diff = sh(`git diff origin/${baseRef}...HEAD || true`).slice(0, 12000);

const prompt = `
You are a senior engineer. Review this pull request diff.
Return:
1) Top risks/bugs
2) Improvements
3) Tests to add
4) Security concerns
Be concise and actionable.

DIFF:
${diff}
`;

const response = await openai.responses.create({
  model: "gpt-5.2",
  input: prompt
});

const review = (response.output_text || "").trim() || "No output from model.";

const body = `## Codex Assistant Review

${review}

<sub>Automated review generated by OpenAI</sub>
`;

// Use GitHub CLI with GH_TOKEN (already provided via workflow env)
sh(`gh pr comment ${prNumber} --body-file -`, { input: body });
console.log("Posted PR comment.");
const review = (response.output_text || "").trim();

const body = review
  ? `## Codex Assistant Review\n\n${review}\n\n<sub>Automated review generated by OpenAI</sub>\n`
  : `## Codex Assistant Review\n\nI ran, but got an empty response from the model. Try re-running the workflow.\n`;
