import OpenAI from "openai";
import { execSync } from "node:child_process";

function sh(cmd) {
  return execSync(cmd, { encoding: "utf8" }).trim();
}

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

// Get PR number from GitHub Actions env
const prNumber = process.env.GITHUB_REF_NAME?.split("/")[0];
if (!prNumber) {
  console.log("No PR number found. This workflow only runs on pull_request.");
  process.exit(0);
}

// Get diff for the PR branch compared to base
const diff = sh("git diff origin/${{ github.base_ref }}...HEAD || true");

// Keep it small so it fits model context
const diffSnippet = diff.slice(0, 12000);

const prompt = `
You are a senior engineer. Review this pull request diff.
Give:
1) The top risks or bugs
2) Suggested improvements
3) Tests to add
4) Any security concerns
Be concise and actionable.

DIFF:
${diffSnippet}
`;

const response = await openai.responses.create({
  model: "gpt-5.2",
  input: prompt
});

const review = response.output_text?.trim() || "No output from model.";

const body = `## Codex Assistant Review

${review}

<sub>Automated review generated by OpenAI</sub>
`;

// Post PR comment using GitHub CLI
sh(`gh pr comment ${prNumber} --body "${body.replace(/"/g, '\\"')}"`);

console.log("Posted PR comment.");
